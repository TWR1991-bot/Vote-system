<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>公司專用記名投票系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .poll-card { transition: transform 0.2s; }
        .poll-card:hover { transform: translateY(-2px); }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">
    <div id="app" class="max-w-4xl mx-auto">
        <!-- 讀取中遮罩 -->
        <div id="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-6 rounded-lg shadow-xl text-center">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mx-auto mb-4"></div>
                <p>處理中，請稍候...</p>
            </div>
        </div>

        <!-- 登入介面 -->
        <div id="login-view" class="glass p-8 rounded-2xl shadow-xl max-w-md mx-auto mt-20">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">公司投票系統</h1>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">帳號</label>
                    <input type="text" id="login-user" class="w-full p-3 mt-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div id="password-field" class="hidden">
                    <label class="block text-sm font-medium text-gray-700">管理員密碼</label>
                    <input type="password" id="login-pass" class="w-full p-3 mt-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <button onclick="handleLogin()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition">登入</button>
            </div>
        </div>

        <!-- 主要內容區 (登入後顯示) -->
        <div id="main-view" class="hidden space-y-6">
            <header class="flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-2xl shadow-sm gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">歡迎, <span id="display-user"></span></h2>
                    <p id="role-tag" class="text-sm text-blue-600 font-medium"></p>
                </div>
                <div class="flex gap-2">
                    <button id="admin-btn" onclick="showAdminPanel()" class="hidden bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">人員管理</button>
                    <button onclick="showCreatePoll()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">發起投票</button>
                    <button onclick="logout()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">登出</button>
                </div>
            </header>

            <div id="poll-list" class="grid gap-6">
                <!-- 投票列表將動態插入此處 -->
            </div>
        </div>

        <!-- 管理面板彈窗 -->
        <div id="admin-panel" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 hidden p-4">
            <div class="bg-white w-full max-w-lg p-8 rounded-2xl shadow-2xl relative">
                <button onclick="closeModal('admin-panel')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                <h3 class="text-xl font-bold mb-6">人員管理 (Admin Only)</h3>
                <div class="flex gap-2 mb-6">
                    <input type="text" id="new-username" placeholder="輸入新員工帳號" class="flex-1 border p-2 rounded-lg">
                    <button onclick="addNewUser()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">新增</button>
                </div>
                <div class="max-h-60 overflow-y-auto border rounded-lg p-4" id="user-list-items">
                    <!-- 使用者名單 -->
                </div>
            </div>
        </div>

        <!-- 建立投票彈窗 -->
        <div id="poll-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 hidden p-4">
            <div class="bg-white w-full max-w-2xl p-8 rounded-2xl shadow-2xl relative max-h-[90vh] overflow-y-auto">
                <button onclick="closeModal('poll-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                <h3 class="text-xl font-bold mb-6">發起新投票</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">投票主題</label>
                        <input type="text" id="poll-title" class="w-full border p-2 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">投票類型</label>
                        <select id="poll-type" class="w-full border p-2 rounded-lg">
                            <option value="single">單選</option>
                            <option value="multiple">複選</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">選項 (每行一個)</label>
                        <textarea id="poll-options" rows="4" class="w-full border p-2 rounded-lg" placeholder="選項 1&#10;選項 2"></textarea>
                    </div>
                    <button onclick="submitNewPoll()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700">發佈投票</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 設定區 ---
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwWY9tfLlHs7NZ90Q32T4Uk4XjdNcNdhClItUzjUoscFQukZqb_JLV4fgkboGXhy_X8/exec';
        const ADMIN_ID = 'Admin01';
        const ADMIN_PASS = '76380260';

        // --- 狀態管理 ---
        let currentUser = null;
        let isAdmin = false;
        let appData = { users: [], polls: [], votes: [] };

        // 監聽管理員帳號輸入
        document.getElementById('login-user').addEventListener('input', (e) => {
            const field = document.getElementById('password-field');
            if (e.target.value === ADMIN_ID) {
                field.classList.remove('hidden');
            } else {
                field.classList.add('hidden');
            }
        });

        // 登入邏輯
        async function handleLogin() {
            const user = document.getElementById('login-user').value.trim();
            const pass = document.getElementById('login-pass').value.trim();

            if (!user) return alert('請輸入帳號');

            if (user === ADMIN_ID) {
                if (pass !== ADMIN_PASS) return alert('管理員密碼錯誤');
                isAdmin = true;
            } else {
                isAdmin = false;
            }

            setLoading(true);
            try {
                await refreshData();
                
                // 檢查使用者是否存在（除管理員外需在清單中）
                const exists = appData.users.find(u => u.username === user);
                if (user !== ADMIN_ID && !exists) {
                    alert('帳號不存在於系統中，請聯絡管理員。');
                    setLoading(false);
                    return;
                }

                currentUser = user;
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('main-view').classList.remove('hidden');
                document.getElementById('display-user').innerText = currentUser;
                document.getElementById('role-tag').innerText = isAdmin ? '系統管理員' : '正式員工';
                
                if (isAdmin) document.getElementById('admin-btn').classList.remove('hidden');
                
                renderPolls();
            } catch (err) {
                alert('登入失敗，請確認 API 設定。');
            } finally {
                setLoading(false);
            }
        }

        // 讀取資料
        async function refreshData() {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'getInitialData' })
            });
            appData = await response.json();
        }

        // 渲染投票列表
        function renderPolls() {
            const list = document.getElementById('poll-list');
            list.innerHTML = '';

            // 按時間排序（最新在前）
            const sortedPolls = [...appData.polls].reverse();

            sortedPolls.forEach(poll => {
                const options = JSON.parse(poll.options);
                const votes = appData.votes.filter(v => v.pollId == poll.id);
                const hasVoted = votes.some(v => v.username === currentUser);
                const isCreator = poll.creator === currentUser;
                const canSeeRealtime = isAdmin || isCreator;
                const isClosed = poll.status === 'closed';

                const card = document.createElement('div');
                card.className = `bg-white p-6 rounded-2xl shadow-sm border-l-8 ${isClosed ? 'border-gray-400' : 'border-blue-500'} poll-card`;
                
                let content = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <span class="px-2 py-1 text-xs font-bold rounded ${isClosed ? 'bg-gray-200 text-gray-600' : 'bg-blue-100 text-blue-700'} mb-2 inline-block">
                                ${isClosed ? '已結算' : '投票中'}
                            </span>
                            <h3 class="text-xl font-bold text-gray-800">${poll.title}</h3>
                            <p class="text-sm text-gray-500">發起人：${poll.creator} | 類型：${poll.type === 'single' ? '單選' : '複選'}</p>
                        </div>
                        ${isAdmin ? `<button onclick="deletePoll('${poll.id}')" class="text-red-500 hover:text-red-700 text-sm">刪除</button>` : ''}
                    </div>
                `;

                if (!isClosed && !hasVoted) {
                    // 投票介面
                    content += `<div class="space-y-2 mt-4">`;
                    options.forEach(opt => {
                        const inputType = poll.type === 'single' ? 'radio' : 'checkbox';
                        content += `
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="${inputType}" name="poll-${poll.id}" value="${opt}" class="mr-3 w-4 h-4 text-blue-600">
                                ${opt}
                            </label>
                        `;
                    });
                    content += `
                        <button onclick="submitVote('${poll.id}', '${poll.type}')" class="mt-4 w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">提交投票</button>
                    </div>`;
                } else {
                    // 結果顯示介面
                    if (isClosed || canSeeRealtime) {
                        content += `<div class="mt-4 space-y-3">`;
                        const stats = {};
                        options.forEach(opt => stats[opt] = 0);
                        votes.forEach(v => {
                            const choices = JSON.parse(v.choice);
                            choices.forEach(c => stats[c]++);
                        });

                        const totalVotes = votes.length;
                        options.forEach(opt => {
                            const count = stats[opt] || 0;
                            const percent = totalVotes > 0 ? Math.round((count / totalVotes) * 100) : 0;
                            content += `
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span>${opt}</span>
                                        <span class="font-bold">${count} 票 (${percent}%)</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="bg-blue-500 h-2 rounded-full" style="width: ${percent}%"></div>
                                    </div>
                                </div>
                            `;
                        });

                        if (canSeeRealtime && !isClosed) {
                            const votedUsers = votes.map(v => v.username);
                            const pendingUsers = appData.users.filter(u => !votedUsers.includes(u.username) && u.username !== ADMIN_ID);
                            content += `
                                <div class="mt-4 p-3 bg-yellow-50 rounded-lg text-xs">
                                    <p class="font-bold text-yellow-800">未投票名單 (${pendingUsers.length}人)：</p>
                                    <p class="text-yellow-700">${pendingUsers.map(u => u.username).join(', ') || '無'}</p>
                                </div>
                                <button onclick="settlePoll('${poll.id}')" class="mt-4 w-full border border-blue-600 text-blue-600 py-2 rounded-lg hover:bg-blue-50">提前結算</button>
                            `;
                        }
                        content += `</div>`;
                    } else {
                        content += `<p class="mt-4 text-center p-4 bg-gray-100 rounded-lg text-gray-600 italic">您已完成投票，請等待發起人結算結果。</p>`;
                    }
                }

                card.innerHTML = content;
                list.appendChild(card);
            });
        }

        // 新增投票
        async function submitNewPoll() {
            const title = document.getElementById('poll-title').value.trim();
            const type = document.getElementById('poll-type').value;
            const optionsRaw = document.getElementById('poll-options').value.trim();
            const options = optionsRaw.split('\n').map(o => o.trim()).filter(o => o);

            if (!title || options.length < 2) return alert('請填寫完整的主題與至少兩個選項');

            setLoading(true);
            await fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'createPoll',
                    id: Date.now().toString(),
                    creator: currentUser,
                    title, type, options
                })
            });
            await refreshData();
            closeModal('poll-modal');
            renderPolls();
            setLoading(false);
        }

        // 提交投票
        async function submitVote(pollId, type) {
            const selected = Array.from(document.querySelectorAll(`input[name="poll-${pollId}"]:checked`)).map(i => i.value);
            if (selected.length === 0) return alert('請至少選擇一個選項');

            setLoading(true);
            await fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'submitVote',
                    pollId,
                    username: currentUser,
                    choice: selected
                })
            });
            await refreshData();
            renderPolls();
            setLoading(false);
        }

        // 結算投票
        async function settlePoll(pollId) {
            if (!confirm('確定要結算此投票嗎？結算後將無法再投票。')) return;
            setLoading(true);
            await fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'settlePoll', pollId })
            });
            await refreshData();
            renderPolls();
            setLoading(false);
        }

        // 刪除投票 (Admin)
        async function deletePoll(pollId) {
            if (!confirm('管理員注意：確定要刪除此投票及其所有記錄嗎？')) return;
            setLoading(true);
            await fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'deletePoll', pollId })
            });
            await refreshData();
            renderPolls();
            setLoading(false);
        }

        // 管理員：新增人員
        async function addNewUser() {
            const name = document.getElementById('new-username').value.trim();
            if (!name) return;
            if (appData.users.some(u => u.username === name)) return alert('此帳號已存在');

            setLoading(true);
            await fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'addUser', username: name })
            });
            await refreshData();
            updateUserList();
            setLoading(false);
            document.getElementById('new-username').value = '';
        }

        function updateUserList() {
            const container = document.getElementById('user-list-items');
            container.innerHTML = appData.users.map(u => `
                <div class="flex justify-between py-2 border-b text-sm">
                    <span>${u.username}</span>
                    <span class="text-gray-400">正式成員</span>
                </div>
            `).join('');
        }

        // --- 輔助功能 ---
        function showAdminPanel() {
            document.getElementById('admin-panel').classList.remove('hidden');
            updateUserList();
        }

        function showCreatePoll() {
            document.getElementById('poll-modal').classList.remove('hidden');
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        function setLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }

        function logout() {
            location.reload();
        }
    </script>
</body>
</html>

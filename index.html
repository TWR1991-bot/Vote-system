<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>企業內部投票系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons：使用明確的 UMD 路徑 -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .tab-active { @apply bg-blue-600 text-white shadow-lg; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

    <!-- 必須在 module 之前定義，否則 __firebase_config 未定義會導致整支腳本崩潰、頁面一直轉圈 -->
    <script>
        // 請替換為您的 Firebase 專案設定（從 Firebase 主控台 > 專案設定 > 一般 > 您的應用程式 取得）
        window.__firebase_config = JSON.stringify({
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        });
        window.__app_id = typeof window.__app_id !== 'undefined' ? window.__app_id : 'voting-app-demo';
        window.__initial_auth_token = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : null;
    </script>

    <div id="app" class="max-w-4xl mx-auto px-4 py-8">
        <!-- 內容將由 JavaScript 動態渲染 -->
        <div class="flex items-center justify-center h-64">
            <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-blue-600 border-solid border-slate-200"></div>
        </div>
    </div>

    <script type="module">
        // --- Firebase SDK 導入 ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 配置與初始化（安全讀取全域變數，避免 ReferenceError）---
        let firebaseConfig;
        try {
            const configStr = typeof window.__firebase_config !== 'undefined' ? window.__firebase_config : '{}';
            firebaseConfig = JSON.parse(configStr);
        } catch (e) {
            firebaseConfig = {};
        }
        if (!firebaseConfig.apiKey || firebaseConfig.apiKey === 'YOUR_API_KEY') {
            document.getElementById('app').innerHTML = `
                <div class="min-h-[80vh] flex items-center justify-center p-4">
                    <div class="bg-white w-full max-w-md p-10 rounded-[2.5rem] shadow-2xl border border-red-100 text-center">
                        <div class="text-red-600 mb-4"><strong>尚未設定 Firebase</strong></div>
                        <p class="text-slate-600 text-sm mb-4">請在 HTML 中搜尋 <code class="bg-slate-100 px-1 rounded">__firebase_config</code>，將 <code>YOUR_API_KEY</code>、<code>YOUR_PROJECT_ID</code> 等替換為您 Firebase 專案的實際設定值。</p>
                        <p class="text-slate-500 text-xs">Firebase 主控台 → 專案設定 → 一般 → 您的應用程式</p>
                    </div>
                </div>
            `;
            throw new Error('Firebase config missing');
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'voting-app-demo';

        const SUPER_ADMIN = "Admin01";
        const ADMIN_PASSWORD = "76380260";

        // --- 全域狀態 ---
        let state = {
            user: null,
            currentUser: null,
            isLoggedIn: false,
            activeTab: 'voting', // 'voting', 'manage', 'users'
            polls: [],
            votes: [],
            votersList: [],
            showAddPoll: false,
            showDetails: {} // 記錄哪個投票要看明細
        };

        // --- 初始化 Auth (遵守 Rule 3) ---
        const initAuth = async () => {
            try {
                if (typeof window.__initial_auth_token !== 'undefined' && window.__initial_auth_token) {
                    await signInWithCustomToken(auth, window.__initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Auth error:", err);
            }
        };

        onAuthStateChanged(auth, (u) => {
            state.user = u;
            if (u) {
                startListening();
            }
            render();
        });

        // --- 資料監聽 (遵守 Rule 1 & 2) ---
        function startListening() {
            if (!state.user) return;

            // 監聽投票
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'polls'), (snap) => {
                state.polls = snap.docs.map(d => ({ id: d.id, ...d.data() }))
                    .sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                render();
            }, (err) => console.error("Polls listener error:", err));

            // 監聽投票紀錄
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'votes'), (snap) => {
                state.votes = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                render();
            }, (err) => console.error("Votes listener error:", err));

            // 監聽人員名單
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'allowed_voters'), (snap) => {
                state.votersList = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                render();
            }, (err) => console.error("Voters listener error:", err));
        }

        // --- 核心操作函數 ---
        window.handleLogin = (e) => {
            e.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password')?.value || "";

            if (username === SUPER_ADMIN) {
                if (password === ADMIN_PASSWORD) {
                    state.isLoggedIn = true;
                    state.currentUser = SUPER_ADMIN;
                } else {
                    alert("管理員密碼錯誤");
                }
            } else if (username) {
                state.isLoggedIn = true;
                state.currentUser = username;
            } else {
                alert("請選擇帳號");
            }
            render();
        };

        window.handleLogout = () => {
            state.isLoggedIn = false;
            state.currentUser = null;
            state.activeTab = 'voting';
            render();
        };

        window.switchTab = (tab) => {
            state.activeTab = tab;
            render();
        };

        window.handleVote = async (pollId, optionIndex) => {
            if (!state.user) return;
            const hasVoted = state.votes.some(v => v.pollId === pollId && v.voterName === state.currentUser);
            if (hasVoted) return alert("您已投過票囉！");
            
            if (!confirm("確認要投下這一票嗎？")) return;

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'votes'), {
                    pollId, optionIndex, voterName: state.currentUser, timestamp: serverTimestamp()
                });
                alert("投票成功！");
            } catch (err) { console.error(err); }
        };

        window.togglePollStatus = async (id, status) => {
            if (!state.user) return;
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'polls', id), { isEnded: !status });
            } catch (err) { console.error(err); }
        };

        window.handleAddPoll = async (e) => {
            if (!state.user) return;
            e.preventDefault();
            const question = document.getElementById('new-question').value;
            const optionInputs = document.querySelectorAll('.new-option-input');
            const options = Array.from(optionInputs).map(i => i.value).filter(v => v.trim() !== "");

            if (!question || options.length < 2) return alert("請填寫完整內容");

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'polls'), {
                    question, options, isEnded: false, createdAt: serverTimestamp()
                });
                state.showAddPoll = false;
                render();
            } catch (err) { console.error(err); }
        };

        window.handleAddVoter = async (e) => {
            if (!state.user) return;
            e.preventDefault();
            const name = document.getElementById('new-voter-name').value;
            if (!name.trim()) return;
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'allowed_voters'), { name: name.trim() });
                document.getElementById('new-voter-name').value = "";
            } catch (err) { console.error(err); }
        };

        window.handleDeleteVoter = async (id) => {
            if (!state.user) return;
            if (!confirm("確定要移除此成員嗎？")) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'allowed_voters', id));
            } catch (err) { console.error(err); }
        };

        window.toggleDetails = (id) => {
            state.showDetails[id] = !state.showDetails[id];
            render();
        };

        // 將 render 函數暴露給 window，解決 ReferenceError
        window.render = render;

        // --- 渲染 UI ---
        function render() {
            const container = document.getElementById('app');
            if (!container) return;
            if (!state.isLoggedIn) {
                container.innerHTML = renderLoginPage();
            } else {
                container.innerHTML = `
                    ${renderHeader()}
                    ${renderTabs()}
                    <div class="animate-fade-in">
                        ${state.activeTab === 'voting' ? renderVoterView() : ''}
                        ${state.activeTab === 'manage' ? renderManageView() : ''}
                        ${state.activeTab === 'users' ? renderUsersView() : ''}
                    </div>
                `;
            }
            if (typeof lucide !== 'undefined' && lucide.createIcons) lucide.createIcons();
        }

        function renderLoginPage() {
            const selectedUser = document.getElementById('login-username')?.value || "";
            return `
                <div class="min-h-[80vh] flex items-center justify-center">
                    <div class="bg-white w-full max-w-md p-10 rounded-[2.5rem] shadow-2xl border border-white animate-fade-in">
                        <div class="text-center mb-8">
                            <div class="bg-blue-600 w-20 h-20 rounded-[2rem] flex items-center justify-center mx-auto mb-6 shadow-xl">
                                <i data-lucide="shield-check" class="text-white w-10 h-10"></i>
                            </div>
                            <h2 class="text-3xl font-black text-slate-800">登入投票系統</h2>
                        </div>
                        <form onsubmit="handleLogin(event)" class="space-y-6">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">選擇人員</label>
                                <select id="login-username" required onchange="render()" class="w-full px-5 py-4 rounded-2xl border-2 border-slate-100 bg-slate-50 font-semibold outline-none focus:border-blue-500 appearance-none">
                                    <option value="">-- 請選擇帳號 --</option>
                                    <option value="${SUPER_ADMIN}" ${selectedUser === SUPER_ADMIN ? 'selected' : ''}>【系統管理員】Admin01</option>
                                    ${state.votersList.map(v => `<option value="${v.name}" ${selectedUser === v.name ? 'selected' : ''}>${v.name}</option>`).join('')}
                                </select>
                            </div>
                            ${selectedUser === SUPER_ADMIN ? `
                                <div class="animate-fade-in">
                                    <label class="block text-sm font-bold text-slate-700 mb-2">管理員密碼</label>
                                    <input type="password" id="login-password" required placeholder="請輸入密碼" class="w-full px-5 py-4 rounded-2xl border-2 border-slate-100 bg-slate-50 font-mono outline-none focus:border-blue-500">
                                </div>
                            ` : ''}
                            <button type="submit" class="w-full bg-slate-900 text-white font-black py-5 rounded-2xl shadow-xl hover:bg-black transition-all">確認進入</button>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderHeader() {
            return `
                <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 bg-white p-6 rounded-3xl shadow-sm border border-slate-100 gap-4">
                    <div>
                        <h1 class="text-2xl font-black text-slate-800 flex items-center gap-2">
                            <i data-lucide="check-circle" class="text-blue-600"></i> 企業內部投票系統
                        </h1>
                        <div class="flex items-center gap-2 mt-2">
                            <span class="text-slate-500 text-sm bg-slate-100 px-3 py-1 rounded-full font-bold">${state.currentUser}</span>
                            <span class="${state.currentUser === SUPER_ADMIN ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'} px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1">
                                <i data-lucide="${state.currentUser === SUPER_ADMIN ? 'shield-check' : 'user-plus'}" class="w-3 h-3"></i>
                                ${state.currentUser === SUPER_ADMIN ? '系統管理員' : '授權發起人'}
                            </span>
                        </div>
                    </div>
                    <button onclick="handleLogout()" class="text-slate-400 hover:text-red-600 font-bold text-sm bg-slate-50 px-4 py-2 rounded-xl flex items-center gap-2">
                        <i data-lucide="log-out" class="w-4 h-4"></i> 登出
                    </button>
                </header>
            `;
        }

        function renderTabs() {
            return `
                <nav class="flex bg-white p-1.5 rounded-2xl shadow-sm border border-slate-100 mb-8 overflow-hidden">
                    <button onclick="switchTab('voting')" class="flex-1 py-3 rounded-xl flex items-center justify-center gap-2 font-bold transition-all ${state.activeTab === 'voting' ? 'tab-active' : 'text-slate-500 hover:bg-slate-50'}">
                        <i data-lucide="activity" class="w-4 h-4"></i> 我要投票
                    </button>
                    <button onclick="switchTab('manage')" class="flex-1 py-3 rounded-xl flex items-center justify-center gap-2 font-bold transition-all ${state.activeTab === 'manage' ? 'tab-active' : 'text-slate-500 hover:bg-slate-50'}">
                        <i data-lucide="layout-dashboard" class="w-4 h-4"></i> 投票管理
                    </button>
                    ${state.currentUser === SUPER_ADMIN ? `
                        <button onclick="switchTab('users')" class="flex-1 py-3 rounded-xl flex items-center justify-center gap-2 font-bold transition-all ${state.activeTab === 'users' ? 'bg-purple-600 text-white shadow-lg' : 'text-slate-500 hover:bg-slate-50'}">
                            <i data-lucide="settings" class="w-4 h-4"></i> 人員工作檯
                        </button>
                    ` : ''}
                </nav>
            `;
        }

        function renderVoterView() {
            const activePolls = state.polls.filter(p => !p.isEnded);
            const endedPolls = state.polls.filter(p => p.isEnded);
            return `
                <section class="space-y-6">
                    <h3 class="text-2xl font-black text-slate-800 flex items-center gap-3"><div class="w-2 h-8 bg-green-500 rounded-full"></div> 進行中的投票</h3>
                    ${activePolls.length === 0 ? '<div class="p-10 text-center bg-white rounded-[2rem] text-slate-300 font-bold">目前暫無活動</div>' : ''}
                    ${activePolls.map(poll => {
                        const hasVoted = state.votes.some(v => v.pollId === poll.id && v.voterName === state.currentUser);
                        const myVote = state.votes.find(v => v.pollId === poll.id && v.voterName === state.currentUser);
                        return `
                            <div class="bg-white p-8 rounded-[2.5rem] shadow-xl border border-slate-50 relative overflow-hidden">
                                <div class="absolute top-0 left-0 w-full h-2 ${hasVoted ? 'bg-green-500' : 'bg-blue-500'}"></div>
                                <h4 class="text-2xl font-black text-slate-800 mb-6">${poll.question}</h4>
                                <div class="grid gap-3">
                                    ${poll.options.map((opt, i) => `
                                        <button onclick="handleVote('${poll.id}', ${i})" ${hasVoted ? 'disabled' : ''} class="w-full py-4 px-6 rounded-2xl text-left border-2 font-bold transition-all flex justify-between items-center ${hasVoted ? (myVote?.optionIndex === i ? 'bg-green-50 border-green-200 text-green-700' : 'bg-slate-50 border-slate-100 text-slate-300') : 'bg-white border-slate-100 hover:border-blue-500 hover:bg-blue-50'}">
                                            <span>${opt}</span>
                                            ${hasVoted && myVote?.optionIndex === i ? '<i data-lucide="check-circle" class="w-5 h-5"></i>' : ''}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }).join('')}
                    
                    ${endedPolls.length > 0 ? `
                        <h3 class="text-2xl font-black text-slate-800 flex items-center gap-3 pt-8"><div class="w-2 h-8 bg-blue-500 rounded-full"></div> 已揭曉結果</h3>
                        <div class="grid gap-6">
                            ${endedPolls.map(poll => renderPollCard(poll, false)).join('')}
                        </div>
                    ` : ''}
                </section>
            `;
        }

        function renderManageView() {
            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-black">投票活動控管</h3>
                        <button onclick="state.showAddPoll = !state.showAddPoll; render()" class="bg-blue-600 text-white px-5 py-2 rounded-xl font-bold flex items-center gap-2 shadow-lg hover:bg-blue-700">
                            <i data-lucide="${state.showAddPoll ? 'trash-2' : 'plus'}" class="w-4 h-4"></i> ${state.showAddPoll ? '取消' : '發起投票'}
                        </button>
                    </div>
                    ${state.showAddPoll ? `
                        <div class="bg-white p-8 rounded-[2rem] shadow-xl border border-blue-50 animate-fade-in">
                            <form onsubmit="handleAddPoll(event)" class="space-y-6">
                                <input type="text" id="new-question" placeholder="輸入投票主題..." class="w-full px-5 py-4 rounded-2xl border-2 border-slate-100 outline-none focus:border-blue-500 font-bold" required>
                                <div class="space-y-3" id="options-container">
                                    <input type="text" class="new-option-input w-full px-5 py-3 rounded-xl border-2 border-slate-100" placeholder="選項 1" required>
                                    <input type="text" class="new-option-input w-full px-5 py-3 rounded-xl border-2 border-slate-100" placeholder="選項 2" required>
                                </div>
                                <button type="button" onclick="const i = document.createElement('input'); i.className='new-option-input w-full px-5 py-3 rounded-xl border-2 border-slate-100 mt-3'; i.placeholder='新選項'; document.getElementById('options-container').appendChild(i);" class="text-blue-600 font-black text-sm">+ 增加更多選項</button>
                                <button type="submit" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black shadow-lg">發布投票</button>
                            </form>
                        </div>
                    ` : ''}
                    <div class="grid gap-6">
                        ${state.polls.map(poll => renderPollCard(poll, true)).join('')}
                    </div>
                </div>
            `;
        }

        function renderPollCard(poll, isAdmin) {
            const pollVotes = state.votes.filter(v => v.pollId === poll.id);
            const showDetails = state.showDetails[poll.id];
            return `
                <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <span class="text-[10px] uppercase font-black px-2 py-0.5 rounded-full ${poll.isEnded ? 'bg-slate-100 text-slate-500' : 'bg-green-100 text-green-700'}">${poll.isEnded ? '已結束' : '進行中'}</span>
                            <h4 class="text-lg font-black text-slate-800 mt-2">${poll.question}</h4>
                        </div>
                        ${isAdmin ? `<button onclick="togglePollStatus('${poll.id}', ${poll.isEnded})" class="text-xs font-black px-4 py-2 rounded-xl border-2 ${poll.isEnded ? 'border-blue-100 text-blue-600' : 'border-orange-100 text-orange-600'}">${poll.isEnded ? '重新開啟' : '結束投票'}</button>` : ''}
                    </div>
                    <div class="flex items-center gap-4 text-xs font-bold text-slate-400 mb-4">
                        <span>總票數: ${pollVotes.length}</span>
                        ${isAdmin ? `<button onclick="toggleDetails('${poll.id}')" class="text-blue-600 ml-auto flex items-center gap-1"><i data-lucide="${showDetails ? 'eye-off' : 'eye'}" class="w-3 h-3"></i> ${showDetails ? '隱藏名單' : '查看明細'}</button>` : ''}
                    </div>
                    ${(poll.isEnded || (isAdmin && showDetails)) ? `
                        <div class="space-y-4 pt-4 border-t border-slate-50">
                            ${poll.options.map((opt, i) => {
                                const count = pollVotes.filter(v => v.optionIndex === i).length;
                                const pct = pollVotes.length > 0 ? Math.round((count / pollVotes.length) * 100) : 0;
                                const voters = pollVotes.filter(v => v.optionIndex === i).map(v => v.voterName);
                                return `
                                    <div class="space-y-1.5">
                                        <div class="flex justify-between text-sm font-bold"><span>${opt}</span><span>${count} 票 (${pct}%)</span></div>
                                        <div class="w-full bg-slate-100 h-2 rounded-full overflow-hidden"><div class="bg-blue-500 h-full" style="width: ${pct}%"></div></div>
                                        ${isAdmin && showDetails && voters.length > 0 ? `<div class="flex flex-wrap gap-1 mt-1">${voters.map(v => `<span class="bg-slate-50 text-[9px] px-1.5 py-0.5 rounded border border-slate-100 text-slate-400">${v}</span>`).join('')}</div>` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderUsersView() {
            return `
                <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                    <h3 class="text-2xl font-black text-slate-800 mb-6 flex items-center gap-2"><i data-lucide="users" class="text-purple-500"></i> 人員工作檯</h3>
                    <form onsubmit="handleAddVoter(event)" class="flex gap-3 mb-8">
                        <input type="text" id="new-voter-name" placeholder="輸入人員姓名..." class="flex-1 px-5 py-3 rounded-xl border-2 border-slate-100 font-bold outline-none focus:border-purple-500">
                        <button type="submit" class="bg-purple-600 text-white px-6 py-3 rounded-xl font-black hover:bg-purple-700">新增授權</button>
                    </form>
                    <div class="divide-y divide-slate-100 border-2 border-slate-50 rounded-2xl overflow-hidden">
                        ${state.votersList.map(v => `
                            <div class="p-4 flex justify-between items-center bg-white hover:bg-slate-50 transition-colors">
                                <span class="font-bold text-slate-700">${v.name}</span>
                                <button onclick="handleDeleteVoter('${v.id}')" class="text-slate-300 hover:text-red-500 transition-all p-2"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // 啟動系統
        window.addEventListener('DOMContentLoaded', async () => {
            await initAuth();
        });
    </script>
</body>
</html>

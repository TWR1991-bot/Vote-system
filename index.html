<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MINECRAFT 公司投票系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --mc-green: #55FF55;
            --mc-dark-green: #388722;
            --mc-dirt: #8B4513;
            --mc-stone: #C6C6C6;
            --mc-bg: #202020;
        }

        body {
            background-color: var(--mc-bg);
            background-image: url('https://www.transparenttextures.com/patterns/dark-matter.png');
            font-family: "Microsoft JhengHei", "微軟正黑體", sans-serif;
            color: white;
        }

        /* 麥塊風格容器 - 取消像素感，改為簡潔方塊 */
        .mc-container {
            background-color: #C6C6C6;
            border: 3px solid #373737;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.2);
            color: #373737;
            padding: 20px;
        }

        /* 麥塊風格按鈕 */
        .mc-btn {
            position: relative;
            background-color: #AAAAAA;
            border: 2px solid #000;
            padding: 10px 20px;
            color: #373737;
            font-weight: bold;
            cursor: pointer;
            display: inline-block;
            transition: all 0.1s;
            text-align: center;
        }
        .mc-btn:hover {
            filter: brightness(1.1);
        }
        .mc-btn:active {
            transform: translate(2px, 2px);
            box-shadow: none;
        }
        .mc-btn-green { background-color: #55FF55; color: #004400; border-color: #388722; }
        .mc-btn-red { background-color: #FF5555; color: #440000; border-color: #AA0000; }
        .mc-btn-purple { background-color: #AA00AA; color: white; border-color: #550055; }

        /* 輸入框 */
        .mc-input {
            background-color: #000;
            border: 2px solid #7A7A7A;
            color: #55FF55;
            padding: 10px;
            outline: none;
            width: 100%;
        }

        /* 經驗值條 (進度條) */
        .exp-bar-bg { background-color: #313131; height: 16px; border: 2px solid #000; position: relative; }
        .exp-bar-fill { background-color: #55FF55; height: 100%; }

        /* 捲軸美化 */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #333; }
        ::-webkit-scrollbar-thumb { background: #888; }

        .poll-card { transition: transform 0.2s; }
        .option-row:nth-child(1) .btn-remove, .option-row:nth-child(2) .btn-remove { display: none; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">
    <div id="app" class="max-w-4xl mx-auto">
        <!-- 載入中畫面 -->
        <div id="loading" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 hidden">
            <div class="mc-container text-center w-80">
                <p id="loading-text" class="text-lg font-bold mb-4">正在載入世界...</p>
                <div class="exp-bar-bg mx-auto">
                    <div class="exp-bar-fill animate-pulse" style="width: 100%"></div>
                </div>
            </div>
        </div>

        <!-- 登入介面 -->
        <div id="login-view" class="mc-container max-w-md mx-auto mt-20">
            <h1 class="text-2xl font-black text-center mb-8 tracking-widest text-stone-800">投票系統：VOTE CRAFT</h1>
            <div class="space-y-6">
                <div>
                    <label class="text-sm font-bold block mb-2">請選擇成員角色：</label>
                    <select id="login-user" class="mc-input bg-stone-700 text-white cursor-pointer font-bold">
                        <option value="">正在載入名單...</option>
                    </select>
                </div>
                <div id="password-field" class="hidden">
                    <label class="text-sm font-bold block mb-2 text-red-600">管理員金鑰：</label>
                    <input type="password" id="login-pass" class="mc-input" placeholder="請輸入密碼">
                </div>
                <button onclick="handleLogin()" class="mc-btn w-full text-lg">進入系統</button>
            </div>
            <div id="url-alert" class="hidden mt-4 p-3 bg-red-900 text-white text-xs border-2 border-red-500">
                錯誤：找不到資料庫網址 (GAS_URL)。
            </div>
        </div>

        <!-- 主要內容區 -->
        <div id="main-view" class="hidden space-y-6">
            <header class="mc-container flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <p class="font-bold">成員名稱：<span id="display-user" class="text-green-700"></span></p>
                    <p id="role-tag" class="text-xs mt-1 text-gray-600 font-bold"></p>
                </div>
                <div class="flex flex-wrap gap-2 justify-center">
                    <button id="admin-btn" onclick="showAdminPanel()" class="mc-btn mc-btn-purple text-xs hidden">管理員後台</button>
                    <button onclick="showCreatePoll()" class="mc-btn mc-btn-green text-xs">發起投票</button>
                    <button onclick="logout()" class="mc-btn text-xs">登出系統</button>
                </div>
            </header>

            <div id="poll-list" class="grid gap-6">
                <!-- 投票列表將動態插入 -->
            </div>
        </div>

        <!-- 管理面板 (人員清單) -->
        <div id="admin-panel" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-40 hidden p-4">
            <div class="mc-container w-full max-w-xl relative">
                <button onclick="closeModal('admin-panel')" class="absolute top-2 right-4 text-2xl font-bold text-red-600">&times;</button>
                <h3 class="text-lg font-bold mb-6 border-b-2 border-stone-400 pb-2">人員管理系統</h3>
                
                <div class="flex gap-2 mb-6">
                    <input type="text" id="new-username" placeholder="請輸入新成員名稱" class="mc-input flex-1">
                    <button onclick="addNewUser()" class="mc-btn mc-btn-green text-xs">新增</button>
                </div>

                <p class="text-xs font-bold mb-2 text-gray-600">目前成員名單：</p>
                <div class="bg-stone-800 p-2 border-2 border-stone-600 max-h-72 overflow-y-auto">
                    <div id="user-list-items" class="space-y-1">
                        <!-- 人員清單 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 建立投票彈窗 -->
        <div id="poll-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-40 hidden p-4">
            <div class="mc-container w-full max-w-2xl relative max-h-[90vh] overflow-y-auto">
                <button onclick="closeModal('poll-modal')" class="absolute top-2 right-4 text-2xl font-bold text-red-600">&times;</button>
                <h3 class="text-lg font-bold mb-6 border-b-2 border-stone-400 pb-2">發起新的投票議題</h3>
                <div class="space-y-6">
                    <div>
                        <label class="text-sm font-bold block mb-2">投票主題：</label>
                        <input type="text" id="poll-title" class="mc-input" placeholder="例如：下次聚餐要去哪？">
                    </div>
                    <div>
                        <label class="text-sm font-bold block mb-2">投票模式：</label>
                        <select id="poll-type" class="mc-input">
                            <option value="single">單選模式</option>
                            <option value="multiple">複選模式</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm font-bold block mb-2">投票選項：</label>
                        <div id="dynamic-options" class="space-y-3">
                            <!-- 選項欄位 -->
                        </div>
                        <button onclick="addOptionField()" class="text-blue-700 font-bold text-sm mt-3 underline">+ 新增選項欄位</button>
                    </div>
                    <button onclick="submitNewPoll()" class="mc-btn mc-btn-green w-full text-lg">確認建立投票</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 設定區 ---
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwWY9tfLlHs7NZ90Q32T4Uk4XjdNcNdhClItUzjUoscFQukZqb_JLV4fgkboGXhy_X8/exec';
        const ADMIN_ID = 'Admin01';
        const ADMIN_PASS = '76380260';

        // --- 狀態管理 ---
        let currentUser = null;
        let isAdmin = false;
        let appData = { users: [], polls: [], votes: [] };

        // 初始化
        window.onload = async () => {
            if (GAS_URL.includes('你的_GOOGLE_APPS_SCRIPT_URL_在此') || !GAS_URL.startsWith('http')) {
                document.getElementById('url-alert').classList.remove('hidden');
                return;
            }

            setLoading(true, "正在連線伺服器...");
            try {
                await refreshData();
                initLoginDropdown();
            } catch (err) {
                alert("連線失敗！請確認 GAS 網址是否正確。");
            } finally {
                setLoading(false);
            }
        };

        // 初始化人員下拉選單
        function initLoginDropdown() {
            const select = document.getElementById('login-user');
            select.innerHTML = '<option value="">-- 請選擇您的名稱 --</option>';
            
            const adminOpt = document.createElement('option');
            adminOpt.value = ADMIN_ID;
            adminOpt.textContent = `[管理員] ${ADMIN_ID}`;
            select.appendChild(adminOpt);

            appData.users.forEach(user => {
                if(user.username !== ADMIN_ID) {
                    const opt = document.createElement('option');
                    opt.value = user.username;
                    opt.textContent = `[一般成員] ${user.username}`;
                    select.appendChild(opt);
                }
            });

            select.onchange = (e) => {
                const field = document.getElementById('password-field');
                field.classList.toggle('hidden', e.target.value !== ADMIN_ID);
            };
        }

        // 登入邏輯
        async function handleLogin() {
            const user = document.getElementById('login-user').value;
            const pass = document.getElementById('login-pass').value.trim();

            if (!user) return alert('請先選擇您的角色！');

            if (user === ADMIN_ID) {
                if (pass !== ADMIN_PASS) return alert('金鑰驗證失敗！');
                isAdmin = true;
            } else {
                isAdmin = false;
            }

            currentUser = user;
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('main-view').classList.remove('hidden');
            document.getElementById('display-user').innerText = currentUser;
            document.getElementById('role-tag').innerText = isAdmin ? '目前模式：管理員 (Creative)' : '目前模式：一般使用者 (Survival)';
            
            if (isAdmin) document.getElementById('admin-btn').classList.remove('hidden');
            renderPolls();
        }

        // 讀取資料
        async function refreshData() {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                mode: 'cors',
                body: JSON.stringify({ action: 'getInitialData' })
            });
            appData = await response.json();
        }

        // 渲染投票列表
        function renderPolls() {
            const list = document.getElementById('poll-list');
            list.innerHTML = '';
            const sortedPolls = [...appData.polls].reverse();

            sortedPolls.forEach(poll => {
                const options = JSON.parse(poll.options);
                const votes = appData.votes.filter(v => v.pollId == poll.id);
                const userVote = votes.find(v => v.username === currentUser);
                const isCreator = poll.creator === currentUser;
                const canSeeRealtime = isAdmin || isCreator;
                const isClosed = poll.status === 'closed';

                const card = document.createElement('div');
                card.className = `mc-container mb-4 ${isClosed ? 'opacity-80 grayscale-[0.3]' : ''}`;
                
                let content = `
                    <div class="flex justify-between items-start mb-4 border-b-2 border-stone-400 pb-2">
                        <div>
                            <span class="text-xs font-bold px-2 py-1 ${isClosed ? 'bg-stone-500' : 'bg-green-600'} text-white">
                                ${isClosed ? '已結算' : '進行中'}
                            </span>
                            <h3 class="text-xl font-bold mt-3 text-stone-800">${poll.title}</h3>
                            <p class="text-xs text-gray-600 mt-2">發起人：${poll.creator}</p>
                        </div>
                        ${isAdmin ? `<button onclick="deletePoll('${poll.id}')" class="mc-btn mc-btn-red text-xs py-1 px-3">刪除</button>` : ''}
                    </div>
                `;

                if (!isClosed && !userVote) {
                    content += `<div class="space-y-4">`;
                    options.forEach(opt => {
                        const inputType = poll.type === 'single' ? 'radio' : 'checkbox';
                        content += `
                            <label class="flex items-center gap-3 p-3 hover:bg-stone-300 cursor-pointer border-2 border-transparent hover:border-black transition">
                                <input type="${inputType}" name="poll-${poll.id}" value="${opt}" class="w-5 h-5 accent-green-600">
                                <span class="font-bold text-stone-700">${opt}</span>
                            </label>
                        `;
                    });
                    content += `<button onclick="submitVote('${poll.id}', '${poll.type}')" class="mc-btn mc-btn-green w-full text-sm mt-4">提交投票</button></div>`;
                } else {
                    content += `<div class="space-y-5">`;
                    const stats = {};
                    options.forEach(opt => stats[opt] = []);
                    votes.forEach(v => {
                        const choices = JSON.parse(v.choice);
                        choices.forEach(c => { if(stats[c]) stats[c].push(v.username); });
                    });

                    options.forEach(opt => {
                        const voters = stats[opt] || [];
                        const percent = votes.length > 0 ? Math.round((voters.length / votes.length) * 100) : 0;
                        content += `
                            <div class="space-y-1">
                                <div class="flex justify-between text-xs font-bold">
                                    <span>${opt}</span>
                                    <span>${voters.length} 票 (${percent}%)</span>
                                </div>
                                <div class="exp-bar-bg">
                                    <div class="exp-bar-fill" style="width: ${percent}%"></div>
                                </div>
                                ${isClosed ? `<p class="text-xs text-stone-500 mt-1">投票者：${voters.join(', ') || '尚無人投票'}</p>` : ''}
                            </div>
                        `;
                    });

                    if (canSeeRealtime && !isClosed) {
                        const votedNames = votes.map(v => v.username);
                        const pending = appData.users.filter(u => !votedNames.includes(u.username) && u.username !== ADMIN_ID);
                        content += `
                            <div class="p-3 bg-stone-300 border-2 border-stone-500 text-xs">
                                <p class="font-bold mb-2 text-stone-800 underline">尚未投票成員 (${pending.length} 人)：</p>
                                <p class="text-stone-700">${pending.map(u => u.username).join(', ') || '全部已投完'}</p>
                            </div>
                            <button onclick="settlePoll('${poll.id}')" class="mc-btn w-full text-xs">立即結束投票並結算</button>
                        `;
                    } else if (!isClosed) {
                        content += `<p class="text-sm text-center p-4 bg-stone-300 italic text-stone-600 font-bold">已成功提交！請等待發起人公布結果。</p>`;
                    }
                    content += `</div>`;
                }

                card.innerHTML = content;
                list.appendChild(card);
            });
        }

        // 選項欄位控制
        function addOptionField(value = "") {
            const container = document.getElementById('dynamic-options');
            const div = document.createElement('div');
            div.className = 'flex gap-2 option-row';
            div.innerHTML = `
                <input type="text" class="mc-input flex-1 poll-opt-input font-bold" value="${value}" placeholder="請輸入選項名稱">
                <button onclick="this.parentElement.remove()" class="text-red-600 px-3 font-black btn-remove text-xl">&times;</button>
            `;
            container.appendChild(div);
        }

        // 建立投票
        async function submitNewPoll() {
            const title = document.getElementById('poll-title').value.trim();
            const type = document.getElementById('poll-type').value;
            const options = Array.from(document.querySelectorAll('.poll-opt-input')).map(i => i.value.trim()).filter(v => v);

            if (!title || options.length < 2) return alert('請輸入主題並提供至少兩個選項！');

            setLoading(true, "正在發佈議題...");
            await fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'createPoll', id: Date.now().toString(), creator: currentUser, title, type, options })
            });
            await refreshData();
            closeModal('poll-modal');
            renderPolls();
            setLoading(false);
        }

        // 管理員：新增人員
        async function addNewUser() {
            const name = document.getElementById('new-username').value.trim();
            if (!name) return;
            if (appData.users.some(u => u.username === name)) return alert('該成員名稱已存在！');

            setLoading(true, "正在新增成員...");
            await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'addUser', username: name }) });
            await refreshData();
            updateUserList();
            initLoginDropdown();
            setLoading(false);
            document.getElementById('new-username').value = '';
        }

        // 更新管理員人員清單
        function updateUserList() {
            const container = document.getElementById('user-list-items');
            container.innerHTML = appData.users.map(u => `
                <div class="flex justify-between items-center bg-stone-700 p-2 border border-stone-600">
                    <span class="text-xs text-white font-bold"># ${u.username}</span>
                    <span class="text-[10px] text-green-500 font-bold">正式成員</span>
                </div>
            `).join('');
        }

        // 其他功能
        async function submitVote(pollId, type) {
            const selected = Array.from(document.querySelectorAll(`input[name="poll-${pollId}"]:checked`)).map(i => i.value);
            if (selected.length === 0) return alert('請至少挑選一個選項！');
            setLoading(true, "傳送資料中...");
            await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'submitVote', pollId, username: currentUser, choice: selected }) });
            await refreshData(); renderPolls(); setLoading(false);
        }

        async function settlePoll(pollId) {
            if (!confirm('確定要結束並結算此投票嗎？')) return;
            setLoading(true, "結算中...");
            await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'settlePoll', pollId }) });
            await refreshData(); renderPolls(); setLoading(false);
        }

        async function deletePoll(pollId) {
            if (!confirm('管理員注意：確定要永久刪除此議題嗎？')) return;
            setLoading(true, "刪除中...");
            await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'deletePoll', pollId }) });
            await refreshData(); renderPolls(); setLoading(false);
        }

        function showAdminPanel() { document.getElementById('admin-panel').classList.remove('hidden'); updateUserList(); }
        function showCreatePoll() { document.getElementById('poll-modal').classList.remove('hidden'); document.getElementById('dynamic-options').innerHTML = ''; addOptionField(); addOptionField(); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function setLoading(show, text = "載入中...") {
            const textElem = document.getElementById('loading-text');
            if (textElem) textElem.innerText = text;
            const loadingElem = document.getElementById('loading');
            if (loadingElem) loadingElem.classList.toggle('hidden', !show);
        }
        function logout() { location.reload(); }
    </script>
</body>
</html>
